<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FLOW TERMINAL</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:#000}
::-webkit-scrollbar-thumb{background:#333}
body{font-family:'JetBrains Mono',monospace;background:#000;color:#c8c8c8;font-size:12px;line-height:1.4;overflow-x:hidden}

/* Bloomberg Colors */
:root{
  --bg:#000000;--panel:#0a0a0a;--border:#1a1a1a;
  --orange:#fb8b1e;--blue:#0068ff;--green:#4af6c3;--red:#ff433d;
  --yellow:#f5d90a;--white:#e8e8e8;--dim:#666;--mid:#999;
}

/* Header */
.hdr{background:#111;border-bottom:2px solid var(--orange);padding:4px 12px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
.hdr-left{display:flex;align-items:center;gap:12px}
.hdr-title{color:var(--orange);font-weight:700;font-size:14px;letter-spacing:1px}
.hdr-status{padding:1px 6px;font-size:10px;font-weight:700;letter-spacing:1px}
.status-live{color:#000;background:var(--green)}
.status-server{color:#000;background:var(--yellow)}
.status-disconnected{color:#fff;background:var(--red)}
.status-demo{color:#000;background:var(--dim)}
.hdr-rt{padding:1px 5px;font-size:9px;font-weight:700;letter-spacing:0.5px;margin-left:4px}
.rt-realtime{color:var(--green);border:1px solid var(--green)}
.rt-delayed{color:var(--orange);border:1px solid var(--orange)}
.hdr-clock{color:var(--green);font-size:13px;font-weight:600}
.hdr-tag{color:var(--dim);font-size:10px}

/* Layout */
.wrap{padding:6px 8px;display:flex;flex-direction:column;gap:4px}
.row{display:flex;gap:4px}
.row>.col{flex:1;min-width:0}

/* Panel */
.pnl{background:var(--panel);border:1px solid var(--border);overflow:hidden}
.pnl-hdr{background:#111;border-bottom:1px solid var(--border);padding:3px 8px;display:flex;justify-content:space-between;align-items:center}
.pnl-title{color:var(--orange);font-weight:700;font-size:11px;letter-spacing:0.5px;text-transform:uppercase}
.pnl-ts{color:var(--dim);font-size:9px;margin-left:auto;padding-left:8px;white-space:nowrap}
.pnl-sub{color:var(--dim);font-size:10px}
.pnl-body{padding:4px 6px}

/* Ticker Strip */
.tickers{display:flex;gap:2px;overflow-x:auto;padding:2px 0}
.tk{padding:4px 10px;background:#0a0a0a;border:1px solid var(--border);flex:1;min-width:0;cursor:default}
.tk-sym{color:var(--yellow);font-weight:700;font-size:11px}
.tk-price{color:var(--white);font-weight:700;font-size:15px;margin:2px 0}
.tk-chg{font-weight:600;font-size:11px}
.tk-hilo{color:var(--dim);font-size:9px;margin-top:1px}
.tk-vol{color:var(--dim);font-size:10px}
.up{color:var(--green)}.dn{color:var(--red)}

/* Tables */
table{width:100%;border-collapse:collapse;font-size:11px}
th{background:#111;color:var(--orange);font-weight:600;padding:3px 6px;text-align:right;border-bottom:1px solid var(--border);white-space:nowrap;position:sticky;top:0;z-index:5;font-size:10px;letter-spacing:0.3px;text-transform:uppercase}
th:first-child{text-align:left}
td{padding:2px 6px;text-align:right;border-bottom:1px solid #0d0d0d;white-space:nowrap}
td:first-child{text-align:left}
tbody tr:hover{background:#0f0f0f}

/* Flow table specifics */
.tbl-wrap{max-height:320px;overflow-y:auto}
.call-row{border-left:2px solid var(--green)}
.put-row{border-left:2px solid var(--red)}
.golden-row{background:#1a1200 !important;border-left:2px solid var(--yellow)}
.golden-row:hover{background:#221800 !important}
.badge{display:inline-block;padding:0 4px;font-weight:700;font-size:10px;letter-spacing:0.5px}
.badge-c{color:#000;background:var(--green)}
.badge-p{color:#000;background:var(--red)}
.badge-bull{color:var(--green)}
.badge-bear{color:var(--red)}
.badge-neut{color:var(--dim)}
.golden-tag{color:var(--yellow);font-size:10px;margin-right:2px}
.exp-tag{color:var(--dim);font-size:9px}

/* Sentiment cards grid */
.sent-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:4px}
.sent-card{background:var(--panel);border:1px solid var(--border);padding:6px 8px}
.sent-sym{color:var(--yellow);font-weight:700;font-size:12px}
.sent-price{color:var(--white);font-weight:700;font-size:14px;margin:2px 0}
.sent-row{display:flex;justify-content:space-between;font-size:10px;color:var(--dim)}
.sent-val{color:var(--mid);font-weight:600}
.sent-bar{height:3px;background:#1a1a1a;margin:4px 0 2px}
.sent-fill{height:100%;min-width:4px}
.pc-tag{font-size:10px;font-weight:700;padding:1px 4px;display:inline-block;margin-top:2px}
.pc-bull{color:var(--green);border:1px solid var(--green)}
.pc-bear{color:var(--red);border:1px solid var(--red)}
.pc-neut{color:var(--yellow);border:1px solid var(--yellow)}

/* Filters */
.filters{display:flex;gap:4px;padding:4px 0;align-items:center}
.fbtn{padding:2px 8px;background:#111;border:1px solid var(--border);color:var(--mid);cursor:pointer;font-family:inherit;font-size:10px;font-weight:600}
.fbtn:hover{border-color:var(--orange);color:var(--orange)}
.fbtn.on{background:var(--orange);color:#000;border-color:var(--orange)}
.fsel{padding:2px 6px;background:#111;border:1px solid var(--border);color:var(--mid);font-family:inherit;font-size:10px}

/* Feed banner */
.feed-banner{display:flex;gap:8px;align-items:center;padding:3px 8px;background:#050500;border:1px solid #1a1a00;font-size:10px;color:var(--dim);margin-bottom:2px}
.feed-dot{width:6px;height:6px;border-radius:50%;background:var(--green)}
.feed-ct{color:var(--green);font-weight:700}

/* Chain - unified table */
.chain-col{display:flex;flex-direction:column}
.chain-col>.pnl{flex:1;display:flex;flex-direction:column}
.chain-wrap{overflow-y:auto;flex:1}
.chain-wrap table{width:100%;height:100%}
.chain-sel{display:flex;gap:6px;align-items:center}
.strike-col{text-align:center !important;background:#111 !important;font-weight:700;color:var(--mid);border-left:1px solid var(--border);border-right:1px solid var(--border);width:70px}
.strike-col.atm-strike{color:var(--orange) !important}
.atm{background:#0a0f1a !important}

/* Chart containers */
.chart-box{position:relative;height:200px}

/* Footer */
.ftr{padding:4px 12px;border-top:1px solid var(--border);color:var(--dim);font-size:9px;display:flex;justify-content:space-between;margin-top:4px}

/* Connection Overlay */
.conn-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:9999;display:flex;align-items:center;justify-content:center}
.conn-box{background:#0a0a0a;border:2px solid var(--orange);padding:32px 40px;max-width:460px;width:100%;font-family:'JetBrains Mono',monospace}
.conn-title{color:var(--orange);font-weight:700;font-size:18px;letter-spacing:2px;text-align:center;margin-bottom:4px}
.conn-sub{color:var(--dim);font-size:10px;text-align:center;margin-bottom:24px}
.conn-mode{display:flex;gap:0;margin-bottom:20px}
.conn-mode-btn{flex:1;padding:8px;text-align:center;background:#111;border:1px solid var(--border);color:var(--dim);cursor:pointer;font-family:inherit;font-size:11px;font-weight:600;letter-spacing:0.5px}
.conn-mode-btn.active{background:var(--orange);color:#000;border-color:var(--orange)}
.conn-mode-btn:hover:not(.active){border-color:var(--orange);color:var(--orange)}
.conn-section{display:none}
.conn-section.active{display:block}
.conn-label{color:var(--mid);font-size:10px;font-weight:600;letter-spacing:0.5px;margin-bottom:4px;display:block;text-transform:uppercase}
.conn-input{width:100%;padding:8px 10px;background:#111;border:1px solid var(--border);color:var(--white);font-family:inherit;font-size:12px;margin-bottom:12px;outline:none}
.conn-input:focus{border-color:var(--orange)}
.conn-input::placeholder{color:#444}
.conn-btn{width:100%;padding:10px;background:var(--orange);color:#000;font-weight:700;font-family:inherit;font-size:13px;letter-spacing:1px;border:none;cursor:pointer;margin-top:8px}
.conn-btn:hover{opacity:0.9}
.conn-btn:disabled{opacity:0.5;cursor:not-allowed}
.conn-disclaimer{color:#444;font-size:9px;text-align:center;margin-top:16px;line-height:1.6}
.conn-error{color:var(--red);font-size:10px;margin-top:8px;display:none}
.conn-demo{text-align:center;margin-top:12px}
.conn-demo a{color:var(--dim);font-size:10px;text-decoration:underline;cursor:pointer}
.conn-demo a:hover{color:var(--orange)}

/* Responsive */
@media(max-width:1200px){.sent-grid{grid-template-columns:repeat(3,1fr)}.chain-wrap{overflow-x:auto}}
@media(max-width:768px){.sent-grid{grid-template-columns:repeat(2,1fr)}.row{flex-direction:column}}
</style>
</head>
<body>

<!-- Connection Overlay -->
<div class="conn-overlay" id="connOverlay">
  <div class="conn-box">
    <div class="conn-title">FLOW TERMINAL</div>
    <div class="conn-sub">Bloomberg-style options flow dashboard powered by LSEG</div>
    <div class="conn-mode">
      <div class="conn-mode-btn active" data-mode="local">LOCAL MODE</div>
      <div class="conn-mode-btn" data-mode="server">SERVER MODE</div>
    </div>
    <div class="conn-section active" id="connLocal">
      <label class="conn-label">App Key</label>
      <input class="conn-input" id="localAppKey" placeholder="Your LSEG App Key (from Workspace)" autocomplete="off">
      <div style="color:var(--dim);font-size:10px;margin-bottom:8px">
        Requires LSEG Workspace + local_bridge.py running on your machine.
      </div>
      <button class="conn-btn" id="localConnect">CONNECT LOCAL</button>
    </div>
    <div class="conn-section" id="connServer">
      <label class="conn-label">Server URL</label>
      <input class="conn-input" id="serverUrl" placeholder="ws://localhost:8000/ws" value="ws://localhost:8000/ws" autocomplete="off">
      <label class="conn-label">App Key</label>
      <input class="conn-input" id="serverAppKey" placeholder="Your LSEG App Key" autocomplete="off">
      <label class="conn-label">Username</label>
      <input class="conn-input" id="serverUser" placeholder="Platform username / machine ID" autocomplete="off">
      <label class="conn-label">Password</label>
      <input class="conn-input" id="serverPass" type="password" placeholder="Platform password" autocomplete="off">
      <button class="conn-btn" id="serverConnect">CONNECT SERVER</button>
    </div>
    <div class="conn-error" id="connError"></div>
    <div class="conn-disclaimer">
      All credentials stay on your machine. Nothing is stored.<br>
      Local mode: data goes Browser ↔ localhost only.<br>
      Server mode: credentials sent over WebSocket (use WSS in production).
    </div>
    <div class="conn-demo"><a id="demoLink">Launch Demo Mode (simulated data)</a></div>
  </div>
</div>

<div class="hdr">
  <div class="hdr-left">
    <span class="hdr-title">FLOW TERMINAL</span>
    <span class="hdr-status status-demo" id="connStatus">DEMO</span>
    <span class="hdr-rt rt-delayed" id="rtBadge" style="display:none">DELAYED</span>
  </div>
  <span class="hdr-clock" id="clock">--:--:--</span>
  <div style="display:flex;gap:12px;align-items:center">
    <span class="hdr-tag">Orders: <span class="feed-ct" id="orderCt">0</span></span>
    <span class="hdr-tag">Premium: <span class="feed-ct" id="totalPrem">$0</span></span>
    <span class="hdr-tag">LSEG/REFINITIV</span>
  </div>
</div>

<div class="wrap">
  <!-- Ticker Strip -->
  <div class="pnl">
    <div class="tickers" id="tickerStrip"></div>
  </div>

  <!-- Sentiment Cards -->
  <div class="pnl">
    <div class="pnl-hdr"><span class="pnl-title">Market Sentiment</span><span class="pnl-sub" id="sentExpLabel">All Expirations</span></div>
    <div class="pnl-body">
      <div class="sent-grid" id="sentGrid"></div>
    </div>
  </div>

  <!-- Main Row: Flow Table + Charts -->
  <div class="row">
    <div class="col" style="flex:2">
      <div class="pnl">
        <div class="pnl-hdr"><span class="pnl-title">Unusual Options Flow</span><span class="pnl-sub" id="flowCount"></span></div>
        <div class="pnl-body">
          <div class="feed-banner">
            <div class="feed-dot" id="feedDot"></div>
            <span id="feedLabel">Live Feed</span>
            <span id="feedPipe">|</span>
            <span id="feedStream">Streaming <span class="feed-ct" id="feedAge">0s</span> ago</span>
          </div>
          <div id="marketClosedBanner" style="display:none;background:#1a1200;border:1px solid #fb8b1e;color:#fb8b1e;padding:4px 10px;font-size:11px;text-align:center;border-radius:4px;margin-bottom:6px;">MARKET CLOSED — Showing last available data</div>
          <div class="filters">
            <button class="fbtn on" data-f="all">ALL</button>
            <button class="fbtn" data-f="calls">CALLS</button>
            <button class="fbtn" data-f="puts">PUTS</button>
            <select class="fsel" id="tkFilter">
              <option value="">ALL TICKERS</option>
              <option>SPY</option><option>QQQ</option><option>AAPL</option><option>MSFT</option><option>NVDA</option>
              <option>TSLA</option><option>AMZN</option><option>GOOG</option><option>META</option>
            </select>
            <select class="fsel" id="expFilter">
              <option value="">ALL EXPIRATIONS</option>
            </select>
          </div>
          <div class="tbl-wrap">
            <table><thead><tr>
              <th>Ticker</th><th>Exp</th><th>Type</th><th>Strike</th><th>Last</th><th>Vol</th><th>OI</th><th>Premium</th><th>Delta</th><th>Signal</th>
            </tr></thead><tbody id="flowBody"></tbody></table>
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="pnl" style="margin-bottom:4px">
        <div class="pnl-hdr"><span class="pnl-title">Put/Call Ratio</span><span class="pnl-ts" id="pcTs"></span></div>
        <div class="pnl-body"><div class="chart-box"><canvas id="pcChart"></canvas></div></div>
      </div>
      <div class="pnl">
        <div class="pnl-hdr"><span class="pnl-title">Flow Distribution</span><span class="pnl-ts" id="flowDistTs"></span>
          <select class="fsel" id="flowDistFilter" style="margin-left:6px"><option value="all">All</option><option>SPY</option><option>QQQ</option><option>AAPL</option><option>MSFT</option><option>NVDA</option><option>TSLA</option><option>AMZN</option><option>GOOG</option><option>META</option></select>
        </div>
        <div class="pnl-body">
          <div class="row">
            <div class="col"><div class="chart-box" style="height:160px"><canvas id="volDonut"></canvas></div></div>
            <div class="col"><div class="chart-box" style="height:160px"><canvas id="premDonut"></canvas></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Second Row: Chain + Strike Volume + Net Flow -->
  <div class="row">
    <div class="col chain-col">
      <div class="pnl">
        <div class="pnl-hdr">
          <span class="pnl-title" id="chainTitle">SPY Options Chain</span>
          <div class="chain-sel">
            <select class="fsel" id="chainTk">
              <option>SPY</option><option>QQQ</option><option>AAPL</option><option>MSFT</option><option>NVDA</option>
              <option>TSLA</option><option>AMZN</option><option>GOOG</option><option>META</option>
            </select>
            <select class="fsel" id="chainExp"></select>
          </div>
        </div>
        <div class="chain-wrap">
          <table>
            <thead><tr>
              <th>Delta</th><th>OI</th><th>Vol</th><th>IV</th><th>Last</th><th>Bid</th>
              <th class="strike-col">Strike</th>
              <th>Bid</th><th>Last</th><th>IV</th><th>Vol</th><th>OI</th><th>Delta</th>
            </tr></thead>
            <tbody id="chainBody"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="pnl" style="margin-bottom:4px">
        <div class="pnl-hdr">
          <span class="pnl-title">Volume by Strike</span><span class="pnl-ts" id="strikeTs"></span>
          <select class="fsel" id="strikeTk" style="margin-left:auto">
            <option>SPY</option><option>QQQ</option><option>AAPL</option><option>MSFT</option><option>NVDA</option>
            <option>TSLA</option><option>AMZN</option><option>GOOG</option><option>META</option>
          </select>
        </div>
        <div class="pnl-body"><div class="chart-box" style="height:280px"><canvas id="strikeChart"></canvas></div></div>
      </div>
      <div class="pnl">
        <div class="pnl-hdr"><span class="pnl-title">Net Flow Sentiment</span><span class="pnl-ts" id="netFlowTs"></span></div>
        <div class="pnl-body"><div class="chart-box" style="height:240px"><canvas id="netChart"></canvas></div></div>
      </div>
    </div>
  </div>
</div>

<div class="ftr">
  <span>Data: LSEG/Refinitiv | For informational purposes only. Not financial advice.</span>
  <span>Built with LSEG MCP + Claude | <span id="ftrTime"></span></span>
</div>

<script>
// ==================== CONFIG ====================
const DEMO_MODE = new URLSearchParams(window.location.search).has('demo');
const TICKERS = ['SPY','QQQ','AAPL','MSFT','NVDA','TSLA','AMZN','GOOG','META'];

// ==================== DEMO DATA (Feb 10 2026) ====================
const DEMO_QUOTES={
  SPY:{last:693.62,chg:-0.33,hi:696.54,lo:692.85,vol:8032384},
  AAPL:{last:273.95,chg:-0.49,hi:275.37,lo:272.94,vol:1402085},
  NVDA:{last:189.33,chg:-0.45,hi:192.48,lo:188.13,vol:7191513},
  TSLA:{last:424.28,chg:6.96,hi:427.24,lo:417.00,vol:1484805},
  QQQ:{last:613.39,chg:-0.93,hi:617.02,lo:612.42,vol:6104761},
  AMZN:{last:208.42,chg:-0.24,hi:212.61,lo:206.46,vol:3058751},
  GOOG:{last:185.43,chg:1.12,hi:186.50,lo:183.90,vol:2145000},
  META:{last:698.50,chg:3.21,hi:701.20,lo:694.80,vol:1876000},
  MSFT:{last:412.75,chg:-1.05,hi:415.30,lo:411.50,vol:2534000}
};

const DEMO_FLOW={
  SPY:{cv:114416,pv:106354,pc:0.930},AAPL:{cv:31837,pv:8446,pc:0.265},
  NVDA:{cv:57905,pv:39398,pc:0.680},TSLA:{cv:97398,pv:58314,pc:0.599},
  QQQ:{cv:40773,pv:56093,pc:1.376},AMZN:{cv:40614,pv:37941,pc:0.934},
  GOOG:{cv:18500,pv:14200,pc:0.768},META:{cv:22300,pv:19800,pc:0.888},
  MSFT:{cv:25400,pv:21600,pc:0.850}
};

const DEMO_UNUSUAL={
  SPY:[
    {s:695,t:'C',v:33902,l:3.31,d:0.4401,exp:'2026-02-13',oi:142800},{s:690,t:'P',v:20706,l:2.55,d:-0.3690,exp:'2026-02-13',oi:98400},
    {s:700,t:'C',v:20426,l:1.04,d:0.2121,exp:'2026-02-14',oi:115200},{s:695,t:'P',v:18197,l:4.27,d:-0.5671,exp:'2026-02-13',oi:87600},
    {s:696,t:'C',v:16365,l:2.74,d:0.3960,exp:'2026-02-13',oi:72400},{s:694,t:'P',v:12930,l:3.87,d:-0.5216,exp:'2026-02-14',oi:63200},
    {s:685,t:'P',v:11836,l:1.53,d:-0.2334,exp:'2026-02-17',oi:54800},{s:697,t:'C',v:8637,l:2.25,d:0.3504,exp:'2026-02-13',oi:41200},
    {s:693,t:'P',v:7806,l:3.49,d:-0.4794,exp:'2026-02-14',oi:38600},{s:694,t:'C',v:7616,l:3.90,d:0.4821,exp:'2026-02-13',oi:35400},
    {s:688,t:'P',v:6968,l:2.07,d:-0.3072,exp:'2026-02-17',oi:31200},{s:692,t:'P',v:6038,l:3.16,d:-0.4399,exp:'2026-02-13',oi:28800},
    {s:696,t:'P',v:5493,l:4.66,d:-0.6143,exp:'2026-02-14',oi:24600},{s:698,t:'C',v:5271,l:1.77,d:0.3040,exp:'2026-02-13',oi:22400},
    {s:693,t:'C',v:4631,l:4.55,d:0.5212,exp:'2026-02-17',oi:19800},{s:689,t:'P',v:4181,l:2.31,d:-0.3369,exp:'2026-02-14',oi:18200},
    {s:701,t:'C',v:3258,l:0.77,d:0.1704,exp:'2026-02-13',oi:15600},{s:699,t:'C',v:3151,l:1.31,d:0.2571,exp:'2026-02-17',oi:14200},
    {s:704,t:'C',v:2973,l:0.26,d:0.0730,exp:'2026-02-14',oi:12800},{s:687,t:'P',v:2435,l:2.01,d:-0.2809,exp:'2026-02-13',oi:11400}
  ],
  AAPL:[
    {s:275,t:'C',v:16425,l:2.04,d:0.4451,exp:'2026-02-13',oi:82400},{s:280,t:'C',v:9394,l:0.52,d:0.1680,exp:'2026-02-14',oi:54200},
    {s:270,t:'P',v:3798,l:1.14,d:-0.2682,exp:'2026-02-13',oi:21600},{s:270,t:'C',v:3334,l:5.19,d:0.7304,exp:'2026-02-17',oi:18400},
    {s:275,t:'P',v:2773,l:3.00,d:-0.5571,exp:'2026-02-14',oi:15200},{s:265,t:'C',v:2684,l:9.35,d:0.8931,exp:'2026-02-13',oi:14800},
    {s:265,t:'P',v:1693,l:0.39,d:-0.1040,exp:'2026-02-17',oi:9200}
  ],
  NVDA:[
    {s:190,t:'C',v:26604,l:2.62,d:0.4701,exp:'2026-02-13',oi:124600},{s:195,t:'C',v:22394,l:0.84,d:0.2117,exp:'2026-02-14',oi:98400},
    {s:185,t:'P',v:13534,l:1.37,d:-0.2831,exp:'2026-02-13',oi:68200},{s:190,t:'P',v:11939,l:3.15,d:-0.5317,exp:'2026-02-17',oi:54800},
    {s:180,t:'P',v:11851,l:0.59,d:-0.1342,exp:'2026-02-13',oi:48200},{s:180,t:'C',v:4708,l:10.00,d:0.8598,exp:'2026-02-14',oi:22400},
    {s:185,t:'C',v:4199,l:5.83,d:0.7145,exp:'2026-02-13',oi:19800},{s:195,t:'P',v:2074,l:6.43,d:-0.7954,exp:'2026-02-17',oi:11200}
  ],
  TSLA:[
    {s:425,t:'C',v:41368,l:6.90,d:0.4959,exp:'2026-02-13',oi:186400},{s:420,t:'C',v:25475,l:9.71,d:0.6072,exp:'2026-02-14',oi:112800},
    {s:430,t:'C',v:23953,l:4.65,d:0.3830,exp:'2026-02-13',oi:98600},{s:430,t:'P',v:20429,l:9.98,d:-0.6179,exp:'2026-02-17',oi:94200},
    {s:420,t:'P',v:19317,l:4.90,d:-0.3920,exp:'2026-02-13',oi:86400},{s:425,t:'P',v:12784,l:7.14,d:-0.5051,exp:'2026-02-14',oi:62400},
    {s:415,t:'C',v:6602,l:12.95,d:0.7081,exp:'2026-02-13',oi:34800},{s:415,t:'P',v:5784,l:3.48,d:-0.2907,exp:'2026-02-17',oi:28600}
  ],
  QQQ:[
    {s:610,t:'P',v:11156,l:3.67,d:-0.3884,exp:'2026-02-13',oi:52400},{s:615,t:'P',v:10219,l:5.46,d:-0.5445,exp:'2026-02-14',oi:48200},
    {s:615,t:'C',v:9146,l:4.29,d:0.4593,exp:'2026-02-13',oi:44800},{s:620,t:'C',v:7371,l:1.94,d:0.2844,exp:'2026-02-17',oi:36200},
    {s:605,t:'P',v:5829,l:2.45,d:-0.2699,exp:'2026-02-13',oi:28400},{s:616,t:'C',v:4341,l:3.62,d:0.4252,exp:'2026-02-14',oi:22600},
    {s:613,t:'P',v:4066,l:4.66,d:-0.4777,exp:'2026-02-13',oi:19800},{s:618,t:'C',v:3220,l:2.72,d:0.3549,exp:'2026-02-17',oi:16400},
    {s:614,t:'P',v:3216,l:5.03,d:-0.5102,exp:'2026-02-14',oi:15200},{s:616,t:'P',v:2661,l:6.11,d:-0.5794,exp:'2026-02-13',oi:13800},
    {s:609,t:'P',v:2634,l:3.46,d:-0.3620,exp:'2026-02-14',oi:12400},{s:619,t:'C',v:2559,l:2.31,d:0.3192,exp:'2026-02-13',oi:11200},
    {s:607,t:'P',v:2505,l:2.83,d:-0.3128,exp:'2026-02-17',oi:10800},{s:614,t:'C',v:2295,l:4.84,d:0.4921,exp:'2026-02-14',oi:9600},
    {s:622,t:'C',v:2052,l:1.24,d:0.2154,exp:'2026-02-13',oi:8400},{s:612,t:'P',v:1926,l:4.30,d:-0.4463,exp:'2026-02-17',oi:7800},
    {s:620,t:'P',v:1906,l:8.25,d:-0.7241,exp:'2026-02-14',oi:7200},{s:617,t:'C',v:1885,l:3.10,d:0.3907,exp:'2026-02-13',oi:6800},
    {s:611,t:'P',v:1784,l:4.17,d:-0.4166,exp:'2026-02-14',oi:6400},{s:610,t:'C',v:1782,l:7.23,d:0.6099,exp:'2026-02-13',oi:5800}
  ],
  AMZN:[
    {s:200,t:'P',v:20824,l:0.53,d:-0.1314,exp:'2026-02-13',oi:92400},{s:215,t:'C',v:20574,l:0.74,d:0.1881,exp:'2026-02-14',oi:88200},
    {s:210,t:'C',v:16648,l:2.16,d:0.4238,exp:'2026-02-13',oi:74600},{s:210,t:'P',v:7171,l:3.60,d:-0.5792,exp:'2026-02-17',oi:34800},
    {s:205,t:'P',v:7044,l:1.48,d:-0.3079,exp:'2026-02-13',oi:32400},{s:215,t:'P',v:2902,l:7.27,d:-0.8207,exp:'2026-02-14',oi:14200},
    {s:205,t:'C',v:2803,l:5.01,d:0.6887,exp:'2026-02-17',oi:12800}
  ],
  GOOG:[
    {s:185,t:'C',v:8200,l:2.80,d:0.4800,exp:'2026-02-13',oi:38400},{s:190,t:'C',v:5400,l:0.95,d:0.2100,exp:'2026-02-14',oi:24600},
    {s:180,t:'P',v:4100,l:1.20,d:-0.2500,exp:'2026-02-13',oi:18800},{s:185,t:'P',v:3800,l:3.10,d:-0.5200,exp:'2026-02-17',oi:16400}
  ],
  META:[
    {s:700,t:'C',v:12400,l:5.50,d:0.4600,exp:'2026-02-13',oi:58200},{s:710,t:'C',v:7800,l:2.10,d:0.2300,exp:'2026-02-14',oi:34800},
    {s:695,t:'P',v:6200,l:3.80,d:-0.3900,exp:'2026-02-13',oi:28600},{s:690,t:'P',v:4500,l:2.40,d:-0.2800,exp:'2026-02-17',oi:21200}
  ],
  MSFT:[
    {s:415,t:'C',v:9800,l:3.20,d:0.4500,exp:'2026-02-13',oi:44800},{s:420,t:'C',v:6100,l:1.40,d:0.2400,exp:'2026-02-14',oi:28200},
    {s:410,t:'P',v:5600,l:2.90,d:-0.3600,exp:'2026-02-13',oi:24600},{s:405,t:'P',v:3200,l:1.50,d:-0.2200,exp:'2026-02-17',oi:15400}
  ]
};

const DEMO_CHAINS={
  SPY:{c:[{s:687,b:8.91,a:8.97,l:8.53,v:55,d:0.7081,iv:null,oi:null},{s:688,b:8.12,a:8.18,l:7.88,v:227,d:0.6827,iv:null,oi:null},{s:689,b:7.35,a:7.41,l:7.47,v:272,d:0.6543,iv:null,oi:null},{s:690,b:6.59,a:6.64,l:6.60,v:976,d:0.6245,iv:null,oi:null},{s:691,b:5.86,a:5.92,l:5.90,v:823,d:0.5931,iv:null,oi:null},{s:692,b:5.19,a:5.21,l:5.20,v:1279,d:0.5581,iv:null,oi:null},{s:693,b:4.51,a:4.53,l:4.55,v:4631,d:0.5212,iv:null,oi:null},{s:694,b:3.88,a:3.90,l:3.89,v:7614,d:0.4821,iv:null,oi:null},{s:695,b:3.29,a:3.31,l:3.31,v:33902,d:0.4401,iv:null,oi:null},{s:696,b:2.73,a:2.74,l:2.77,v:16363,d:0.3960,iv:null,oi:null},{s:697,b:2.22,a:2.24,l:2.25,v:8637,d:0.3504,iv:null,oi:null},{s:698,b:1.77,a:1.78,l:1.77,v:5271,d:0.3040,iv:null,oi:null},{s:699,b:1.37,a:1.38,l:1.31,v:3151,d:0.2571,iv:null,oi:null},{s:700,b:1.04,a:1.05,l:1.04,v:20426,d:0.2121,iv:null,oi:null},{s:701,b:0.75,a:0.76,l:0.77,v:3258,d:0.1704,iv:null,oi:null}],p:[{s:687,b:1.89,a:1.90,l:2.01,v:2435,d:-0.2809,iv:null,oi:null},{s:688,b:2.10,a:2.11,l:2.07,v:6968,d:-0.3072,iv:null,oi:null},{s:689,b:2.32,a:2.34,l:2.31,v:4181,d:-0.3369,iv:null,oi:null},{s:690,b:2.57,a:2.58,l:2.55,v:20702,d:-0.3690,iv:null,oi:null},{s:691,b:2.84,a:2.86,l:2.82,v:2195,d:-0.4025,iv:null,oi:null},{s:692,b:3.15,a:3.16,l:3.16,v:6038,d:-0.4399,iv:null,oi:null},{s:693,b:3.47,a:3.49,l:3.48,v:7805,d:-0.4794,iv:null,oi:null},{s:694,b:3.84,a:3.85,l:3.86,v:12880,d:-0.5216,iv:null,oi:null},{s:695,b:4.25,a:4.27,l:4.27,v:18197,d:-0.5671,iv:null,oi:null},{s:696,b:4.71,a:4.75,l:4.66,v:5493,d:-0.6143,iv:null,oi:null},{s:697,b:5.19,a:5.29,l:5.21,v:1475,d:-0.6646,iv:null,oi:null},{s:698,b:5.66,a:5.87,l:5.95,v:1332,d:-0.7184,iv:null,oi:null},{s:699,b:6.27,a:6.49,l:6.83,v:218,d:-0.7670,iv:null,oi:null},{s:700,b:7.03,a:7.14,l:7.04,v:1030,d:-0.8169,iv:null,oi:null},{s:701,b:7.68,a:7.90,l:8.00,v:55,d:-0.8681,iv:null,oi:null}]},
  QQQ:{c:[{s:606,b:10.34,a:10.44,l:12.00,v:114,d:0.6998,iv:null,oi:null},{s:607,b:9.60,a:9.63,l:9.45,v:92,d:0.6775,iv:null,oi:null},{s:608,b:8.83,a:8.86,l:8.73,v:168,d:0.6548,iv:null,oi:null},{s:609,b:8.10,a:8.12,l:8.22,v:306,d:0.6302,iv:null,oi:null},{s:610,b:7.39,a:7.41,l:7.23,v:1782,d:0.6040,iv:null,oi:null},{s:611,b:6.70,a:6.72,l:6.81,v:461,d:0.5766,iv:null,oi:null},{s:612,b:6.04,a:6.06,l:5.85,v:750,d:0.5474,iv:null,oi:null},{s:613,b:5.40,a:5.42,l:5.27,v:975,d:0.5169,iv:null,oi:null},{s:614,b:4.82,a:4.84,l:4.84,v:2295,d:0.4855,iv:null,oi:null},{s:615,b:4.23,a:4.24,l:4.29,v:9146,d:0.4524,iv:null,oi:null},{s:616,b:3.70,a:3.72,l:3.62,v:4341,d:0.4183,iv:null,oi:null},{s:617,b:3.19,a:3.20,l:3.10,v:1885,d:0.3837,iv:null,oi:null},{s:618,b:2.73,a:2.75,l:2.72,v:3220,d:0.3485,iv:null,oi:null},{s:619,b:2.31,a:2.33,l:2.31,v:2559,d:0.3128,iv:null,oi:null},{s:620,b:1.92,a:1.93,l:1.94,v:7371,d:0.2774,iv:null,oi:null}],p:[{s:606,b:2.62,a:2.64,l:2.75,v:913,d:-0.2969,iv:null,oi:null},{s:607,b:2.84,a:2.86,l:2.93,v:2504,d:-0.3193,iv:null,oi:null},{s:608,b:3.11,a:3.12,l:3.14,v:1224,d:-0.3432,iv:null,oi:null},{s:609,b:3.37,a:3.39,l:3.46,v:2634,d:-0.3685,iv:null,oi:null},{s:610,b:3.64,a:3.66,l:3.64,v:11155,d:-0.3951,iv:null,oi:null},{s:611,b:3.95,a:3.97,l:4.17,v:1784,d:-0.4234,iv:null,oi:null},{s:612,b:4.31,a:4.33,l:4.30,v:1926,d:-0.4534,iv:null,oi:null},{s:613,b:4.67,a:4.69,l:4.84,v:4053,d:-0.4845,iv:null,oi:null},{s:614,b:5.07,a:5.09,l:5.03,v:3216,d:-0.5169,iv:null,oi:null},{s:615,b:5.51,a:5.53,l:5.50,v:10192,d:-0.5508,iv:null,oi:null},{s:616,b:5.96,a:5.98,l:6.11,v:2661,d:-0.5862,iv:null,oi:null},{s:617,b:6.48,a:6.50,l:6.40,v:1246,d:-0.6214,iv:null,oi:null},{s:618,b:6.98,a:7.03,l:6.95,v:1475,d:-0.6581,iv:null,oi:null},{s:619,b:7.59,a:7.64,l:7.79,v:625,d:-0.6946,iv:null,oi:null},{s:620,b:7.92,a:8.64,l:8.25,v:1906,d:-0.7297,iv:null,oi:null}]},
  AAPL:{c:[{s:260,b:14.50,a:14.60,l:14.55,v:480,d:0.9500,iv:null,oi:8200},{s:262.5,b:12.10,a:12.20,l:12.15,v:720,d:0.9100,iv:null,oi:6400},{s:265,b:9.30,a:9.40,l:9.35,v:2684,d:0.8931,iv:null,oi:14800},{s:267.5,b:7.45,a:7.55,l:7.50,v:890,d:0.8200,iv:null,oi:5400},{s:270,b:5.15,a:5.25,l:5.19,v:3334,d:0.7271,iv:null,oi:18400},{s:272.5,b:3.70,a:3.80,l:3.75,v:2100,d:0.6100,iv:null,oi:12200},{s:275,b:2.08,a:2.11,l:2.04,v:16425,d:0.4443,iv:null,oi:82400},{s:277.5,b:1.15,a:1.18,l:1.16,v:3400,d:0.3200,iv:null,oi:24600},{s:280,b:0.53,a:0.55,l:0.52,v:9394,d:0.1670,iv:null,oi:54200},{s:282.5,b:0.22,a:0.24,l:0.23,v:4200,d:0.0850,iv:null,oi:28400},{s:285,b:0.08,a:0.10,l:0.09,v:2800,d:0.0380,iv:null,oi:18600},{s:287.5,b:0.03,a:0.05,l:0.04,v:1200,d:0.0150,iv:null,oi:9800},{s:290,b:0.01,a:0.03,l:0.02,v:680,d:0.0060,iv:null,oi:6200}],p:[{s:260,b:0.12,a:0.14,l:0.13,v:920,d:-0.0450,iv:null,oi:7400},{s:262.5,b:0.22,a:0.24,l:0.23,v:1100,d:-0.0850,iv:null,oi:8800},{s:265,b:0.38,a:0.40,l:0.39,v:1693,d:-0.1040,iv:null,oi:14800},{s:267.5,b:0.62,a:0.65,l:0.63,v:1400,d:-0.1700,iv:null,oi:9200},{s:270,b:1.10,a:1.12,l:1.14,v:3798,d:-0.2693,iv:null,oi:21600},{s:272.5,b:1.75,a:1.78,l:1.76,v:2200,d:-0.3800,iv:null,oi:14400},{s:275,b:2.95,a:2.98,l:3.00,v:2773,d:-0.5580,iv:null,oi:15200},{s:277.5,b:4.30,a:4.35,l:4.32,v:1800,d:-0.6700,iv:null,oi:11200},{s:280,b:6.40,a:6.70,l:6.70,v:182,d:-0.8430,iv:null,oi:4800},{s:282.5,b:8.80,a:9.10,l:8.95,v:120,d:-0.9100,iv:null,oi:3200},{s:285,b:11.20,a:11.50,l:11.35,v:85,d:-0.9550,iv:null,oi:2400},{s:287.5,b:13.70,a:14.00,l:13.85,v:42,d:-0.9800,iv:null,oi:1600},{s:290,b:16.20,a:16.50,l:16.35,v:18,d:-0.9920,iv:null,oi:800}]},
  NVDA:{c:[{s:172.5,b:17.20,a:17.40,l:17.30,v:320,d:0.9600,iv:null,oi:4200},{s:175,b:14.80,a:15.00,l:14.90,v:680,d:0.9300,iv:null,oi:7800},{s:177.5,b:12.40,a:12.60,l:12.50,v:1200,d:0.8900,iv:null,oi:11400},{s:180,b:10.00,a:10.10,l:10.00,v:4708,d:0.8598,iv:null,oi:22400},{s:182.5,b:7.80,a:7.90,l:7.85,v:2800,d:0.7800,iv:null,oi:16200},{s:185,b:5.80,a:5.85,l:5.83,v:4199,d:0.7145,iv:null,oi:19800},{s:187.5,b:4.10,a:4.15,l:4.12,v:5200,d:0.5900,iv:null,oi:28400},{s:190,b:2.60,a:2.62,l:2.62,v:26603,d:0.4701,iv:null,oi:124600},{s:192.5,b:1.50,a:1.53,l:1.51,v:8400,d:0.3300,iv:null,oi:42800},{s:195,b:0.83,a:0.84,l:0.84,v:22394,d:0.2117,iv:null,oi:98400},{s:197.5,b:0.38,a:0.40,l:0.39,v:6800,d:0.1200,iv:null,oi:34200},{s:200,b:0.15,a:0.17,l:0.16,v:4200,d:0.0580,iv:null,oi:22400},{s:202.5,b:0.05,a:0.07,l:0.06,v:1800,d:0.0240,iv:null,oi:12800}],p:[{s:172.5,b:0.08,a:0.10,l:0.09,v:580,d:-0.0350,iv:null,oi:5200},{s:175,b:0.18,a:0.20,l:0.19,v:1200,d:-0.0650,iv:null,oi:8400},{s:177.5,b:0.35,a:0.38,l:0.36,v:2400,d:-0.1050,iv:null,oi:12800},{s:180,b:0.58,a:0.60,l:0.59,v:11851,d:-0.1342,iv:null,oi:48200},{s:182.5,b:0.92,a:0.95,l:0.93,v:4200,d:-0.2100,iv:null,oi:18400},{s:185,b:1.39,a:1.40,l:1.37,v:13534,d:-0.2831,iv:null,oi:68200},{s:187.5,b:2.15,a:2.18,l:2.16,v:5100,d:-0.4000,iv:null,oi:28600},{s:190,b:3.15,a:3.20,l:3.15,v:11939,d:-0.5317,iv:null,oi:54800},{s:192.5,b:4.40,a:4.45,l:4.42,v:7200,d:-0.6600,iv:null,oi:36400},{s:195,b:6.40,a:6.45,l:6.43,v:2074,d:-0.7954,iv:null,oi:11200},{s:197.5,b:8.60,a:8.80,l:8.70,v:980,d:-0.8750,iv:null,oi:6800},{s:200,b:11.10,a:11.30,l:11.20,v:420,d:-0.9350,iv:null,oi:4200},{s:202.5,b:13.60,a:13.80,l:13.70,v:180,d:-0.9700,iv:null,oi:2400}]},
  TSLA:{c:[{s:395,b:31.50,a:31.80,l:31.65,v:820,d:0.9400,iv:null,oi:4800},{s:400,b:26.80,a:27.10,l:26.95,v:1600,d:0.9100,iv:null,oi:8400},{s:405,b:22.20,a:22.50,l:22.35,v:2400,d:0.8600,iv:null,oi:14200},{s:410,b:17.80,a:18.10,l:17.95,v:3800,d:0.7800,iv:null,oi:22400},{s:415,b:12.90,a:13.00,l:12.95,v:6602,d:0.7081,iv:null,oi:34800},{s:420,b:9.55,a:9.70,l:9.65,v:25456,d:0.6072,iv:null,oi:112800},{s:425,b:6.80,a:6.90,l:6.82,v:41366,d:0.4959,iv:null,oi:186400},{s:430,b:4.60,a:4.70,l:4.62,v:23853,d:0.3830,iv:null,oi:98600},{s:435,b:2.85,a:2.95,l:2.90,v:12400,d:0.2700,iv:null,oi:62800},{s:440,b:1.60,a:1.70,l:1.65,v:8200,d:0.1750,iv:null,oi:44200},{s:445,b:0.80,a:0.88,l:0.84,v:5400,d:0.1050,iv:null,oi:28400},{s:450,b:0.35,a:0.42,l:0.38,v:3200,d:0.0580,iv:null,oi:18200},{s:455,b:0.12,a:0.18,l:0.15,v:1400,d:0.0280,iv:null,oi:9800}],p:[{s:395,b:1.20,a:1.30,l:1.25,v:1800,d:-0.0550,iv:null,oi:9200},{s:400,b:1.80,a:1.90,l:1.85,v:2800,d:-0.0850,iv:null,oi:14400},{s:405,b:2.60,a:2.70,l:2.65,v:3600,d:-0.1350,iv:null,oi:18800},{s:410,b:3.45,a:3.55,l:3.50,v:4800,d:-0.2150,iv:null,oi:24600},{s:415,b:3.45,a:3.50,l:3.48,v:5784,d:-0.2907,iv:null,oi:28600},{s:420,b:4.95,a:5.00,l:5.00,v:19293,d:-0.3920,iv:null,oi:86400},{s:425,b:7.15,a:7.25,l:7.16,v:12779,d:-0.5051,iv:null,oi:62400},{s:430,b:9.90,a:10.05,l:10.05,v:20422,d:-0.6179,iv:null,oi:94200},{s:435,b:13.20,a:13.40,l:13.30,v:8400,d:-0.7250,iv:null,oi:48200},{s:440,b:16.80,a:17.10,l:16.95,v:4200,d:-0.8200,iv:null,oi:28400},{s:445,b:20.50,a:20.80,l:20.65,v:2400,d:-0.8900,iv:null,oi:16800},{s:450,b:24.50,a:24.80,l:24.65,v:1200,d:-0.9350,iv:null,oi:9600},{s:455,b:28.80,a:29.20,l:29.00,v:580,d:-0.9650,iv:null,oi:5400}]},
  AMZN:{c:[{s:192.5,b:16.50,a:16.70,l:16.60,v:420,d:0.9500,iv:null,oi:3800},{s:195,b:14.10,a:14.30,l:14.20,v:880,d:0.9200,iv:null,oi:6400},{s:197.5,b:11.70,a:11.90,l:11.80,v:1400,d:0.8800,iv:null,oi:9800},{s:200,b:9.20,a:9.30,l:9.25,v:1800,d:0.8500,iv:null,oi:14200},{s:202.5,b:7.10,a:7.20,l:7.15,v:2200,d:0.7700,iv:null,oi:18800},{s:205,b:5.00,a:5.10,l:5.01,v:2803,d:0.6759,iv:null,oi:12800},{s:207.5,b:3.40,a:3.50,l:3.45,v:4800,d:0.5500,iv:null,oi:32400},{s:210,b:2.16,a:2.19,l:2.16,v:16648,d:0.4121,iv:null,oi:74600},{s:212.5,b:1.25,a:1.28,l:1.26,v:5200,d:0.2900,iv:null,oi:38200},{s:215,b:0.72,a:0.73,l:0.74,v:20574,d:0.1824,iv:null,oi:88200},{s:217.5,b:0.32,a:0.34,l:0.33,v:6800,d:0.1000,iv:null,oi:42400},{s:220,b:0.12,a:0.14,l:0.13,v:3400,d:0.0480,iv:null,oi:24600},{s:222.5,b:0.04,a:0.06,l:0.05,v:1200,d:0.0200,iv:null,oi:12800}],p:[{s:192.5,b:0.10,a:0.12,l:0.11,v:680,d:-0.0420,iv:null,oi:4200},{s:195,b:0.22,a:0.24,l:0.23,v:1200,d:-0.0750,iv:null,oi:7800},{s:197.5,b:0.40,a:0.43,l:0.41,v:2200,d:-0.1150,iv:null,oi:12400},{s:200,b:0.50,a:0.55,l:0.53,v:20824,d:-0.1314,iv:null,oi:92400},{s:202.5,b:0.85,a:0.88,l:0.86,v:3400,d:-0.2200,iv:null,oi:18800},{s:205,b:1.46,a:1.49,l:1.48,v:7044,d:-0.3199,iv:null,oi:32400},{s:207.5,b:2.30,a:2.35,l:2.32,v:4800,d:-0.4400,iv:null,oi:24200},{s:210,b:3.55,a:3.65,l:3.60,v:7171,d:-0.5915,iv:null,oi:34800},{s:212.5,b:5.10,a:5.20,l:5.15,v:3200,d:-0.7050,iv:null,oi:18400},{s:215,b:7.10,a:7.25,l:7.27,v:2902,d:-0.8279,iv:null,oi:14200},{s:217.5,b:9.40,a:9.60,l:9.50,v:1200,d:-0.8950,iv:null,oi:8800},{s:220,b:11.80,a:12.00,l:11.90,v:580,d:-0.9450,iv:null,oi:5200},{s:222.5,b:14.30,a:14.60,l:14.45,v:240,d:-0.9750,iv:null,oi:2800}]},
  GOOG:{c:[{s:170,b:15.20,a:15.40,l:15.30,v:380,d:0.9500,iv:null,oi:3400},{s:172.5,b:13.00,a:13.20,l:13.10,v:680,d:0.9200,iv:null,oi:5200},{s:175,b:10.80,a:11.00,l:10.90,v:1500,d:0.8700,iv:null,oi:9800},{s:177.5,b:8.70,a:8.90,l:8.80,v:1100,d:0.8100,iv:null,oi:7400},{s:180,b:6.80,a:6.90,l:6.85,v:2400,d:0.7000,iv:null,oi:18800},{s:182.5,b:5.10,a:5.20,l:5.15,v:3200,d:0.6100,iv:null,oi:16400},{s:185,b:3.30,a:3.40,l:3.35,v:8200,d:0.4800,iv:null,oi:38400},{s:187.5,b:2.05,a:2.15,l:2.10,v:4500,d:0.3600,iv:null,oi:22600},{s:190,b:1.05,a:1.10,l:1.08,v:5400,d:0.2100,iv:null,oi:24600},{s:192.5,b:0.48,a:0.52,l:0.50,v:3200,d:0.1150,iv:null,oi:16400},{s:195,b:0.18,a:0.22,l:0.20,v:1800,d:0.0550,iv:null,oi:9800},{s:197.5,b:0.06,a:0.08,l:0.07,v:800,d:0.0220,iv:null,oi:5400},{s:200,b:0.02,a:0.04,l:0.03,v:340,d:0.0080,iv:null,oi:2800}],p:[{s:170,b:0.08,a:0.10,l:0.09,v:420,d:-0.0400,iv:null,oi:3800},{s:172.5,b:0.18,a:0.20,l:0.19,v:780,d:-0.0750,iv:null,oi:5800},{s:175,b:0.35,a:0.38,l:0.36,v:1200,d:-0.1200,iv:null,oi:8400},{s:177.5,b:0.60,a:0.63,l:0.61,v:1800,d:-0.1800,iv:null,oi:11200},{s:180,b:1.05,a:1.08,l:1.06,v:4100,d:-0.2900,iv:null,oi:18800},{s:182.5,b:1.70,a:1.73,l:1.71,v:3500,d:-0.3800,iv:null,oi:14600},{s:185,b:2.80,a:2.85,l:2.82,v:3800,d:-0.5200,iv:null,oi:16400},{s:187.5,b:4.15,a:4.25,l:4.20,v:2900,d:-0.6300,iv:null,oi:12800},{s:190,b:5.80,a:5.90,l:5.85,v:2100,d:-0.7800,iv:null,oi:9400},{s:192.5,b:7.80,a:8.00,l:7.90,v:1200,d:-0.8800,iv:null,oi:6200},{s:195,b:10.20,a:10.40,l:10.30,v:620,d:-0.9400,iv:null,oi:3800},{s:197.5,b:12.70,a:12.90,l:12.80,v:280,d:-0.9700,iv:null,oi:2200},{s:200,b:15.20,a:15.50,l:15.35,v:120,d:-0.9900,iv:null,oi:1200}]},
  META:{c:[{s:665,b:36.50,a:37.00,l:36.75,v:280,d:0.9700,iv:null,oi:2400},{s:670,b:31.80,a:32.20,l:32.00,v:520,d:0.9500,iv:null,oi:4200},{s:675,b:27.20,a:27.60,l:27.40,v:880,d:0.9200,iv:null,oi:6800},{s:680,b:22.50,a:22.80,l:22.65,v:1400,d:0.8800,iv:null,oi:9600},{s:685,b:17.50,a:17.60,l:17.55,v:1800,d:0.8500,iv:null,oi:14200},{s:690,b:13.80,a:13.90,l:13.85,v:2400,d:0.7600,iv:null,oi:18800},{s:695,b:10.20,a:10.30,l:10.25,v:4800,d:0.6400,iv:null,oi:28600},{s:700,b:7.10,a:7.20,l:7.15,v:12400,d:0.5100,iv:null,oi:58200},{s:705,b:4.50,a:4.60,l:4.55,v:8200,d:0.3600,iv:null,oi:42400},{s:710,b:2.50,a:2.60,l:2.55,v:7800,d:0.2300,iv:null,oi:34800},{s:715,b:1.20,a:1.30,l:1.25,v:3200,d:0.1200,iv:null,oi:18600},{s:720,b:0.48,a:0.55,l:0.52,v:1800,d:0.0580,iv:null,oi:11200},{s:725,b:0.15,a:0.22,l:0.18,v:820,d:0.0250,iv:null,oi:6400}],p:[{s:665,b:0.80,a:0.90,l:0.85,v:420,d:-0.0250,iv:null,oi:3200},{s:670,b:1.20,a:1.30,l:1.25,v:680,d:-0.0450,iv:null,oi:4800},{s:675,b:1.75,a:1.85,l:1.80,v:1100,d:-0.0750,iv:null,oi:7200},{s:680,b:2.30,a:2.40,l:2.35,v:1600,d:-0.1150,iv:null,oi:9800},{s:685,b:2.80,a:2.90,l:2.85,v:1500,d:-0.1400,iv:null,oi:12400},{s:690,b:3.60,a:3.70,l:3.65,v:2800,d:-0.2300,iv:null,oi:21200},{s:695,b:5.00,a:5.10,l:5.05,v:6200,d:-0.3500,iv:null,oi:28600},{s:700,b:7.30,a:7.40,l:7.35,v:5400,d:-0.4800,iv:null,oi:24800},{s:705,b:10.10,a:10.20,l:10.15,v:3600,d:-0.6300,iv:null,oi:18400},{s:710,b:13.20,a:13.30,l:13.25,v:2200,d:-0.7600,iv:null,oi:12800},{s:715,b:16.80,a:16.90,l:16.85,v:1400,d:-0.8700,iv:null,oi:8200},{s:720,b:20.50,a:20.80,l:20.65,v:680,d:-0.9350,iv:null,oi:4800},{s:725,b:24.50,a:24.80,l:24.65,v:320,d:-0.9700,iv:null,oi:2400}]},
  MSFT:{c:[{s:385,b:29.50,a:29.80,l:29.65,v:320,d:0.9600,iv:null,oi:2800},{s:390,b:24.80,a:25.10,l:24.95,v:680,d:0.9300,iv:null,oi:5200},{s:395,b:20.20,a:20.50,l:20.35,v:1200,d:0.8900,iv:null,oi:8800},{s:400,b:14.50,a:14.60,l:14.55,v:2100,d:0.8600,iv:null,oi:14200},{s:405,b:10.80,a:10.90,l:10.85,v:3400,d:0.7400,iv:null,oi:22400},{s:410,b:7.30,a:7.40,l:7.35,v:5600,d:0.6000,iv:null,oi:24600},{s:415,b:4.20,a:4.30,l:4.25,v:9800,d:0.4500,iv:null,oi:44800},{s:420,b:2.10,a:2.20,l:2.15,v:6100,d:0.2800,iv:null,oi:28200},{s:425,b:0.90,a:0.95,l:0.92,v:3800,d:0.1500,iv:null,oi:18400},{s:430,b:0.32,a:0.38,l:0.35,v:2200,d:0.0700,iv:null,oi:12200},{s:435,b:0.10,a:0.14,l:0.12,v:1200,d:0.0300,iv:null,oi:7400},{s:440,b:0.03,a:0.05,l:0.04,v:520,d:0.0120,iv:null,oi:4200},{s:445,b:0.01,a:0.03,l:0.02,v:180,d:0.0040,iv:null,oi:2200}],p:[{s:385,b:0.60,a:0.70,l:0.65,v:480,d:-0.0350,iv:null,oi:3800},{s:390,b:1.00,a:1.10,l:1.05,v:880,d:-0.0650,iv:null,oi:6200},{s:395,b:1.60,a:1.70,l:1.65,v:1400,d:-0.1050,iv:null,oi:9400},{s:400,b:1.30,a:1.40,l:1.35,v:1400,d:-0.1300,iv:null,oi:8800},{s:405,b:2.40,a:2.50,l:2.45,v:3200,d:-0.2500,iv:null,oi:15400},{s:410,b:4.10,a:4.20,l:4.15,v:5600,d:-0.3900,iv:null,oi:24600},{s:415,b:6.50,a:6.60,l:6.55,v:4200,d:-0.5400,iv:null,oi:18800},{s:420,b:9.60,a:9.70,l:9.65,v:2800,d:-0.7100,iv:null,oi:14200},{s:425,b:13.30,a:13.40,l:13.35,v:1600,d:-0.8400,iv:null,oi:8400},{s:430,b:17.20,a:17.50,l:17.35,v:820,d:-0.9250,iv:null,oi:5200},{s:435,b:21.40,a:21.70,l:21.55,v:420,d:-0.9650,iv:null,oi:3200},{s:440,b:25.80,a:26.10,l:25.95,v:180,d:-0.9850,iv:null,oi:1800},{s:445,b:30.20,a:30.50,l:30.35,v:85,d:-0.9950,iv:null,oi:1000}]}
};

const DEMO_EXPIRATIONS = ['2026-02-13', '2026-02-14', '2026-02-17'];

// ==================== LIVE STATE ====================
const lp = {};
const liveFlow = {};
const liveUnusual = {};
const liveChains = {};
let availableExpirations = [];
let selectedChainTk = 'SPY';
let selectedChainExp = '';
let orderCt = 0, totalPrem = 0, feedAge = 0;
let connectionMode = 'demo'; // 'local', 'server', 'demo'
let isRealtime = false;

// ==================== DATA PROVIDER ====================
class DataProvider {
  constructor() {
    this.ws = null;
    this.callbacks = { quote: [], flow: [], chain: [], status: [], snapshot: [], expirations: [] };
    this.reconnectTimer = null;
    this.config = null;
  }

  on(event, cb) { if (this.callbacks[event]) this.callbacks[event].push(cb); }
  emit(event, ...args) { (this.callbacks[event] || []).forEach(cb => cb(...args)); }

  connect(mode, config) {
    this.config = { mode, ...config };
    const url = mode === 'local' ? 'ws://localhost:8765' : config.serverUrl;

    try {
      this.ws = new WebSocket(url);
    } catch (e) {
      this.emit('status', { status: 'error', msg: 'Invalid WebSocket URL' });
      return;
    }

    this.ws.onopen = () => {
      if (mode === 'server') {
        this.ws.send(JSON.stringify({
          app_key: config.appKey,
          username: config.username,
          password: config.password,
        }));
      }
      this.emit('status', { status: 'connecting', msg: 'WebSocket connected, waiting for data...' });
    };

    this.ws.onmessage = (event) => {
      try {
        const msg = JSON.parse(event.data);
        switch (msg.type) {
          case 'snapshot':
            this.emit('snapshot', msg);
            this.emit('status', { status: msg.status || 'connected', msg: msg.msg || 'Receiving data' });
            break;
          case 'quote_update':
            this.emit('quote', msg.ticker, msg.data);
            break;
          case 'flow_update':
            this.emit('flow', msg.ticker, msg.data);
            break;
          case 'chain_update':
            this.emit('chain', msg.ticker, msg.expiration, msg.data);
            break;
          case 'expirations_update':
            this.emit('expirations', msg.expirations);
            break;
          case 'status':
            this.emit('status', msg);
            break;
          case 'error':
            this.emit('status', { status: 'error', msg: msg.msg });
            break;
        }
      } catch (e) {
        console.error('WS parse error:', e);
      }
    };

    this.ws.onclose = () => {
      this.emit('status', { status: 'disconnected', msg: 'Connection lost' });
      // Auto-reconnect after 5s
      if (this.reconnectTimer) clearTimeout(this.reconnectTimer);
      this.reconnectTimer = setTimeout(() => {
        if (this.config) this.connect(this.config.mode, this.config);
      }, 5000);
    };

    this.ws.onerror = () => {
      this.emit('status', { status: 'error', msg: 'Connection error' });
    };
  }

  disconnect() {
    if (this.reconnectTimer) clearTimeout(this.reconnectTimer);
    this.reconnectTimer = null;
    this.config = null;
    if (this.ws) {
      this.ws.onclose = null; // prevent reconnect
      this.ws.close();
      this.ws = null;
    }
  }
}

let provider = null;

// ==================== UTILS ====================
const fmtN = n => { n = Number(n) || 0; return n >= 1e6 ? (n/1e6).toFixed(1)+'M' : n >= 1e3 ? (n/1e3).toFixed(1)+'K' : n.toFixed(0); };
const fmtD = n => (Number(n) || 0).toFixed(2);
const fmtP = n => {
  n = Number(n) || 0;
  if (n >= 1e6) return '$' + (n/1e6).toFixed(2) + 'M';
  if (n >= 1e3) return '$' + (n/1e3).toFixed(1) + 'K';
  return '$' + n.toFixed(0);
};
const sig = (d, t) => t === 'C' ? (d > 0.3 ? 'BULL' : d > 0 ? 'NEUT' : 'BEAR') : (Math.abs(d) > 0.3 ? 'BEAR' : 'NEUT');
const sigCls = s => s === 'BULL' ? 'badge-bull' : s === 'BEAR' ? 'badge-bear' : 'badge-neut';
const pcCls = r => r < 0.7 ? 'pc-bull' : r > 1.0 ? 'pc-bear' : 'pc-neut';
const fmtOI = n => { if (n == null) return '--'; n = Number(n); return n >= 1e3 ? (n/1e3).toFixed(1)+'K' : n.toFixed(0); };
const fmtIV = n => { if (n == null) return '--'; return (Number(n)*100).toFixed(1)+'%'; };

// ==================== RENDER ====================
function renderTickers() {
  const el = document.getElementById('tickerStrip');
  el.innerHTML = TICKERS.map(t => {
    const q = lp[t] || {};
    const last = q.last || 0; const chg = q.chg || 0;
    const cls = chg >= 0 ? 'up' : 'dn'; const s = chg >= 0 ? '+' : '';
    return `<div class="tk" id="tk-${t}"><div class="tk-sym">${t}</div><div class="tk-price" id="tp-${t}">${fmtD(last)}</div><div class="tk-chg ${cls}" id="tc-${t}">${s}${fmtD(chg)}</div><div class="tk-hilo">H: ${fmtD(q.hi||0)} L: ${fmtD(q.lo||0)}</div><div class="tk-vol">Vol ${fmtN(q.vol||0)}</div></div>`;
  }).join('');
}

function renderSentiment() {
  const el = document.getElementById('sentGrid');
  el.innerHTML = TICKERS.map(t => {
    const q = lp[t] || {};
    const f = liveFlow[t] || { cv: 0, pv: 0, pc: 0 };
    const tot = (f.cv || 0) + (f.pv || 0);
    const pct = tot > 0 ? ((f.cv || 0) / tot * 100).toFixed(0) : '50';
    const cls = pcCls(f.pc || 0);
    return `<div class="sent-card"><div class="sent-sym">${t}</div><div class="sent-price" id="sp-${t}">${fmtD(q.last||0)}</div><div class="sent-row"><span>Calls</span><span class="sent-val">${fmtN(f.cv||0)}</span></div><div class="sent-row"><span>Puts</span><span class="sent-val">${fmtN(f.pv||0)}</span></div><div class="sent-bar"><div class="sent-fill" style="width:${pct}%;background:var(--green)"></div></div><span class="pc-tag ${cls}">P/C ${(f.pc||0).toFixed(3)}</span></div>`;
  }).join('');
}

function buildFlowRows() {
  const rows = [];
  Object.keys(liveUnusual).forEach(tk => {
    (liveUnusual[tk] || []).forEach(a => {
      const prem = (a.v || 0) * (a.l || 0) * 100;
      const s = sig(a.d || 0, a.t);
      rows.push({ tk, t: a.t, s: a.s, l: a.l || 0, v: a.v || 0, d: a.d || 0, oi: a.oi || null, exp: a.exp || '', prem, sig: s });
    });
  });
  rows.sort((a, b) => b.prem - a.prem);
  orderCt = rows.length;
  totalPrem = rows.reduce((s, r) => s + r.prem, 0);
  return rows;
}

function renderFlow() {
  const rows = buildFlowRows();
  const tbody = document.getElementById('flowBody');
  tbody.innerHTML = rows.map(r => {
    const golden = r.prem > 5e6;
    const rc = r.t === 'C' ? 'call-row' : 'put-row';
    const bc = r.t === 'C' ? 'badge-c' : 'badge-p';
    const tl = r.t === 'C' ? 'CALL' : 'PUT';
    const sc = sigCls(r.sig);
    const gt = golden ? '<span class="golden-tag">\u2605</span>' : '';
    const expStr = r.exp ? `<span class="exp-tag">${r.exp}</span>` : '';
    return `<tr class="${golden?'golden-row':rc}"><td><b>${r.tk}</b></td><td>${expStr}</td><td><span class="badge ${bc}">${tl}</span></td><td>$${r.s}</td><td>${fmtD(r.l)}</td><td>${fmtN(r.v)}</td><td>${fmtOI(r.oi)}</td><td>${gt}<b>${fmtP(r.prem)}</b></td><td>${(r.d).toFixed(4)}</td><td><span class="${sc}">${r.sig}</span></td></tr>`;
  }).join('');
  document.getElementById('flowCount').textContent = rows.length + ' orders';
  document.getElementById('orderCt').textContent = orderCt.toLocaleString();
  document.getElementById('totalPrem').textContent = fmtP(totalPrem);
}

function renderChain() {
  const tk = selectedChainTk;
  const tkChains = liveChains[tk];
  if (!tkChains) return;
  // Pick selected expiration, or fall back to first available
  const data = (selectedChainExp && tkChains[selectedChainExp])
    ? tkChains[selectedChainExp]
    : Object.values(tkChains)[0];
  if (!data) return;
  const price = (lp[tk] || {}).last || 0;
  const tbody = document.getElementById('chainBody');
  const strikes = data.c.map(c => c.s);

  // Pad to at least 10 rows
  const minRows = Math.max(strikes.length, 10);

  tbody.innerHTML = strikes.map((strike, i) => {
    const c = data.c[i] || {};
    const p = data.p[i] || {};
    const isAtm = price > 0 && Math.abs(strike - price) < (CHAIN_CFG_JS[tk] || 1);
    const atmCls = isAtm ? 'atm' : '';
    const strikeCls = isAtm ? 'strike-col atm-strike' : 'strike-col';
    return `<tr class="${atmCls}"><td>${(c.d||0).toFixed(4)}</td><td>${fmtOI(c.oi)}</td><td>${fmtN(c.v||0)}</td><td style="color:var(--dim)">${fmtIV(c.iv)}</td><td id="cc-${tk}-${strike}">${fmtD(c.l||0)}</td><td>${c.b!=null?fmtD(c.b):'--'}</td><td class="${strikeCls}">${strike}</td><td>${p.b!=null?fmtD(p.b):'--'}</td><td id="cp-${tk}-${strike}">${fmtD(p.l||0)}</td><td style="color:var(--dim)">${fmtIV(p.iv)}</td><td>${fmtN(p.v||0)}</td><td>${fmtOI(p.oi)}</td><td>${(p.d||0).toFixed(4)}</td></tr>`;
  }).join('');

  document.getElementById('chainTitle').textContent = tk + ' Options Chain';
}

// ATM threshold per ticker for chain highlighting
const CHAIN_CFG_JS = { SPY: 1, QQQ: 1, AAPL: 2.5, MSFT: 2.5, NVDA: 2.5, TSLA: 2.5, AMZN: 2.5, GOOG: 2.5, META: 2.5 };

// ==================== CHARTS ====================
Chart.defaults.color = '#666';
Chart.defaults.borderColor = '#1a1a1a';
Chart.defaults.font.family = "'JetBrains Mono',monospace";
Chart.defaults.font.size = 10;

let pcChartInst, strikeInst, netInst, volDonutInst, premDonutInst;

function stampTs(id) {
  const el = document.getElementById(id);
  if (el) el.textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function renderPCChart() {
  const tk = TICKERS;
  const vals = tk.map(t => (liveFlow[t] || {}).pc || 0);
  const colors = vals.map(v => v < 0.7 ? '#4af6c3' : v > 1.0 ? '#ff433d' : '#fb8b1e');
  if (pcChartInst) pcChartInst.destroy();
  pcChartInst = new Chart(document.getElementById('pcChart'), {
    type: 'bar', data: { labels: tk, datasets: [{ data: vals, backgroundColor: colors, borderWidth: 0, borderRadius: 2, barThickness: 14 }] },
    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, animation: false,
      plugins: { legend: { display: false } },
      scales: { x: { grid: { color: '#111' }, max: 1.5, ticks: { callback: v => v.toFixed(1) } }, y: { grid: { display: false }, ticks: { font: { weight: '600' } } } } }
  });
  stampTs('pcTs');
}

function renderDonuts() {
  const filter = document.getElementById('flowDistFilter')?.value || 'all';
  const filteredTickers = filter === 'all' ? TICKERS : [filter];
  let tcv = 0, tpv = 0, tcp = 0, tpp = 0;
  filteredTickers.forEach(t => { tcv += (liveFlow[t] || {}).cv || 0; tpv += (liveFlow[t] || {}).pv || 0; });
  filteredTickers.forEach(t => (liveUnusual[t] || []).forEach(a => { const p = (a.v||0) * (a.l||0) * 100; a.t === 'C' ? tcp += p : tpp += p; }));
  if (volDonutInst) volDonutInst.destroy();
  if (premDonutInst) premDonutInst.destroy();
  volDonutInst = new Chart(document.getElementById('volDonut'), {
    type: 'doughnut', data: { labels: ['Calls', 'Puts'], datasets: [{ data: [tcv, tpv], backgroundColor: ['#4af6c3', '#ff433d'], borderWidth: 0 }] },
    options: { responsive: true, maintainAspectRatio: false, animation: false, cutout: '65%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 8, padding: 4, font: { size: 9 } } } } }
  });
  premDonutInst = new Chart(document.getElementById('premDonut'), {
    type: 'doughnut', data: { labels: ['Call $', 'Put $'], datasets: [{ data: [tcp, tpp], backgroundColor: ['#4af6c3', '#ff433d'], borderWidth: 0 }] },
    options: { responsive: true, maintainAspectRatio: false, animation: false, cutout: '65%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 8, padding: 4, font: { size: 9 } } } } }
  });
  stampTs('flowDistTs');
}

function renderStrikeChart() {
  const tk = document.getElementById('strikeTk').value;
  const tkChains = liveChains[tk];
  if (!tkChains) return;
  const d = (selectedChainExp && tkChains[selectedChainExp])
    ? tkChains[selectedChainExp]
    : Object.values(tkChains)[0];
  if (!d) return;
  const strikes = d.c.map(c => c.s);
  const cv = d.c.map(c => c.v || 0);
  const pv = d.p.map(p => p.v || 0);
  if (strikeInst) strikeInst.destroy();
  strikeInst = new Chart(document.getElementById('strikeChart'), {
    type: 'bar', data: { labels: strikes, datasets: [{ label: 'Calls', data: cv, backgroundColor: '#4af6c3', borderWidth: 0, borderRadius: 1 }, { label: 'Puts', data: pv, backgroundColor: '#ff433d', borderWidth: 0, borderRadius: 1 }] },
    options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { labels: { boxWidth: 8, padding: 4 } } }, scales: { x: { grid: { color: '#111' } }, y: { grid: { color: '#111' } } } }
  });
  stampTs('strikeTs');
}

function renderNetFlow() {
  const tks = TICKERS;
  const bull = [], bear = [];
  tks.forEach(t => {
    let b = 0, r = 0;
    (liveUnusual[t] || []).forEach(a => {
      const p = (a.v||0) * (a.l||0) * 100;
      if (a.t === 'C' && a.d > 0.3) b += p;
      if (a.t === 'P' && Math.abs(a.d) > 0.3) r += p;
    });
    bull.push(b); bear.push(r);
  });
  if (netInst) netInst.destroy();
  netInst = new Chart(document.getElementById('netChart'), {
    type: 'bar', data: { labels: tks, datasets: [{ label: 'Bullish', data: bull, backgroundColor: '#4af6c3', borderWidth: 0, borderRadius: 1 }, { label: 'Bearish', data: bear, backgroundColor: '#ff433d', borderWidth: 0, borderRadius: 1 }] },
    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { labels: { boxWidth: 8, padding: 4 } } }, scales: { x: { grid: { color: '#111' }, stacked: false }, y: { grid: { display: false }, stacked: false } } }
  });
  stampTs('netFlowTs');
}

function renderAllCharts() {
  renderPCChart();
  renderDonuts();
  renderStrikeChart();
  renderNetFlow();
}

// ==================== FILTERS ====================
function setupFilters() {
  document.querySelectorAll('.fbtn').forEach(b => {
    b.addEventListener('click', () => { document.querySelectorAll('.fbtn').forEach(x => x.classList.remove('on')); b.classList.add('on'); filterFlow(); });
  });
  document.getElementById('tkFilter').addEventListener('change', filterFlow);
  document.getElementById('expFilter').addEventListener('change', filterFlow);
}

function filterFlow() {
  const ft = document.querySelector('.fbtn.on')?.dataset.f || 'all';
  const tk = document.getElementById('tkFilter').value;
  const exp = document.getElementById('expFilter').value;
  document.querySelectorAll('#flowBody tr').forEach(r => {
    const rtk = r.cells[0].textContent;
    const rexp = r.cells[1]?.textContent || '';
    const rt = r.cells[2].textContent.includes('CALL') ? 'calls' : 'puts';
    let show = true;
    if (ft === 'calls' && rt !== 'calls') show = false;
    if (ft === 'puts' && rt !== 'puts') show = false;
    if (tk && rtk !== tk) show = false;
    if (exp && !rexp.includes(exp)) show = false;
    r.style.display = show ? '' : 'none';
  });
}

// ==================== EXPIRATION MANAGEMENT ====================
function updateExpirationDropdowns(exps) {
  availableExpirations = exps || [];
  const chainExpEl = document.getElementById('chainExp');
  const expFilterEl = document.getElementById('expFilter');

  // Chain expiration dropdown
  const prevChain = chainExpEl.value;
  chainExpEl.innerHTML = exps.map(e => `<option value="${e}">${e}</option>`).join('');
  if (prevChain && exps.includes(prevChain)) chainExpEl.value = prevChain;
  else if (exps.length > 0) { chainExpEl.value = exps[0]; selectedChainExp = exps[0]; }

  // Flow filter dropdown
  const prevFilter = expFilterEl.value;
  expFilterEl.innerHTML = '<option value="">ALL EXPIRATIONS</option>' + exps.map(e => `<option value="${e}">${e}</option>`).join('');
  if (prevFilter) expFilterEl.value = prevFilter;

  // Sentiment label
  document.getElementById('sentExpLabel').textContent = exps.length > 1 ? `${exps.length} Expirations` : (exps[0] || 'All Expirations');
}

// ==================== CONNECTION STATUS ====================
function updateConnectionStatus(status, mode, msg) {
  const el = document.getElementById('connStatus');
  const rtEl = document.getElementById('rtBadge');
  const feedDot = document.getElementById('feedDot');
  const feedLabel = document.getElementById('feedLabel');
  el.className = 'hdr-status';

  // Feed dot color: green=live, orange=delayed, red=disconnected, gray=demo
  if (feedDot) {
    if (status === 'connected') feedDot.style.background = 'var(--green)';
    else if (status === 'delayed') feedDot.style.background = 'var(--orange)';
    else if (status === 'disconnected' || status === 'error') feedDot.style.background = 'var(--red)';
    else feedDot.style.background = 'var(--dim)';
  }

  // Feed label text
  if (feedLabel) {
    if (msg === 'Market closed') feedLabel.textContent = 'MARKET CLOSED';
    else if (status === 'connected') feedLabel.textContent = 'Live Feed';
    else if (status === 'delayed') feedLabel.textContent = 'DELAYED FEED (15MIN)';
    else if (status === 'disconnected' || status === 'error') feedLabel.textContent = 'Disconnected';
    else feedLabel.textContent = 'Demo Mode';
  }

  // Market closed banner
  const mcBanner = document.getElementById('marketClosedBanner');
  if (mcBanner) mcBanner.style.display = (msg === 'Market closed') ? '' : 'none';

  // Hide streaming counter when market is closed
  const feedPipe = document.getElementById('feedPipe');
  const feedStream = document.getElementById('feedStream');
  if (feedPipe && feedStream) {
    const showStream = (msg !== 'Market closed');
    feedPipe.style.display = showStream ? '' : 'none';
    feedStream.style.display = showStream ? '' : 'none';
  }

  if (status === 'connected' || status === 'connecting') {
    if (mode === 'local') {
      el.textContent = 'LOCAL STREAM';
      el.classList.add('status-live');
    } else if (mode === 'server') {
      el.textContent = 'SERVER 2-3s';
      el.classList.add('status-server');
    } else {
      el.textContent = 'LIVE';
      el.classList.add('status-live');
    }
  } else if (status === 'disconnected' || status === 'error') {
    el.textContent = 'DISCONNECTED';
    el.classList.add('status-disconnected');
  } else if (status === 'delayed') {
    if (mode === 'local') {
      el.textContent = 'LOCAL STREAM';
      el.classList.add('status-live');
    } else {
      el.textContent = 'SERVER';
      el.classList.add('status-server');
    }
    rtEl.textContent = 'DELAYED 15MIN';
    rtEl.className = 'hdr-rt rt-delayed';
    rtEl.style.display = '';
    isRealtime = false;
    return;
  } else {
    el.textContent = 'DEMO';
    el.classList.add('status-demo');
  }

  // RT badge
  if (status === 'connected' && mode !== 'demo') {
    rtEl.textContent = 'RT';
    rtEl.className = 'hdr-rt rt-realtime';
    rtEl.style.display = '';
    isRealtime = true;
  } else if (mode === 'demo') {
    rtEl.style.display = 'none';
  }
}

// ==================== CONNECTION OVERLAY ====================
function setupConnectionOverlay() {
  const overlay = document.getElementById('connOverlay');
  const modeBtns = document.querySelectorAll('.conn-mode-btn');
  const localSection = document.getElementById('connLocal');
  const serverSection = document.getElementById('connServer');
  const errorEl = document.getElementById('connError');

  // If ?demo=true, skip overlay
  if (DEMO_MODE) {
    overlay.style.display = 'none';
    startDemoMode();
    return;
  }

  // Mode toggle
  modeBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      modeBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const mode = btn.dataset.mode;
      localSection.classList.toggle('active', mode === 'local');
      serverSection.classList.toggle('active', mode === 'server');
      errorEl.style.display = 'none';
    });
  });

  // Local connect
  document.getElementById('localConnect').addEventListener('click', () => {
    errorEl.style.display = 'none';
    overlay.style.display = 'none';
    connectionMode = 'local';
    startLiveMode('local', {});
  });

  // Server connect
  document.getElementById('serverConnect').addEventListener('click', () => {
    const serverUrl = document.getElementById('serverUrl').value.trim();
    const appKey = document.getElementById('serverAppKey').value.trim();
    const username = document.getElementById('serverUser').value.trim();
    const password = document.getElementById('serverPass').value.trim();

    if (!serverUrl || !appKey || !username || !password) {
      errorEl.textContent = 'All fields required for server mode.';
      errorEl.style.display = 'block';
      return;
    }

    errorEl.style.display = 'none';
    overlay.style.display = 'none';
    connectionMode = 'server';
    startLiveMode('server', { serverUrl, appKey, username, password });
  });

  // Demo link
  document.getElementById('demoLink').addEventListener('click', () => {
    overlay.style.display = 'none';
    startDemoMode();
  });
}

// ==================== LIVE MODE ====================
function startLiveMode(mode, config) {
  updateConnectionStatus('connecting', mode);

  provider = new DataProvider();

  provider.on('snapshot', (msg) => {
    // Load initial data
    if (msg.quotes) {
      Object.keys(msg.quotes).forEach(tk => { lp[tk] = { ...msg.quotes[tk] }; });
    }
    if (msg.chains) {
      Object.keys(msg.chains).forEach(tk => { liveChains[tk] = msg.chains[tk]; });
    }
    if (msg.flow) {
      Object.keys(msg.flow).forEach(tk => {
        liveFlow[tk] = msg.flow[tk];
        if (msg.flow[tk].unusual) liveUnusual[tk] = msg.flow[tk].unusual;
      });
    }
    if (msg.expirations) {
      // Expirations can be a list (new) or object (legacy)
      const exps = Array.isArray(msg.expirations)
        ? msg.expirations.filter(e => e)
        : Object.values(msg.expirations).filter(e => e);
      if (exps.length > 0) updateExpirationDropdowns([...new Set(exps)]);
    }
    if (msg.status) updateConnectionStatus(msg.status, mode, msg.msg);
    renderAll();
  });

  provider.on('quote', (ticker, data) => {
    const prev = lp[ticker] || {};
    Object.keys(data).forEach(k => { if (data[k] != null) prev[k] = data[k]; });
    lp[ticker] = prev;
    feedAge = 0;

    // Efficient DOM update (no full re-render)
    const pe = document.getElementById('tp-' + ticker);
    const ce = document.getElementById('tc-' + ticker);
    const se = document.getElementById('sp-' + ticker);
    if (pe) {
      const old = parseFloat(pe.textContent);
      pe.textContent = fmtD(prev.last || 0);
      pe.style.color = (prev.last || 0) > old ? 'var(--green)' : (prev.last || 0) < old ? 'var(--red)' : 'var(--white)';
    }
    if (ce) {
      const chg = prev.chg || 0;
      ce.textContent = (chg >= 0 ? '+' : '') + fmtD(chg);
      ce.className = 'tk-chg ' + (chg >= 0 ? 'up' : 'dn');
    }
    if (se) {
      se.textContent = fmtD(prev.last || 0);
    }
  });

  provider.on('flow', (ticker, data) => {
    liveFlow[ticker] = data;
    if (data.unusual) liveUnusual[ticker] = data.unusual;
    renderFlow();
    renderSentiment();
    renderAllCharts();
  });

  provider.on('chain', (ticker, expiration, data) => {
    if (!liveChains[ticker]) liveChains[ticker] = {};
    liveChains[ticker][expiration] = data;
    if (ticker === selectedChainTk) renderChain();
    if (ticker === document.getElementById('strikeTk').value) renderStrikeChart();
  });

  provider.on('expirations', (exps) => {
    if (exps && exps.length > 0) updateExpirationDropdowns(exps);
  });

  provider.on('status', (msg) => {
    const st = msg.status || 'connected';
    updateConnectionStatus(st, mode, msg.msg);

    if (st === 'error') {
      console.error('Connection error:', msg.msg);
      // Show error on overlay
      const errorEl = document.getElementById('connError');
      errorEl.textContent = msg.msg || 'Connection failed';
      errorEl.style.display = 'block';
      document.getElementById('connOverlay').style.display = 'flex';
    }
  });

  provider.connect(mode, config);
}

// ==================== DEMO MODE (Simulation Engine) ====================
let demoTimers = [];

function startDemoMode() {
  connectionMode = 'demo';
  updateConnectionStatus('demo', 'demo');

  // Load demo data
  TICKERS.forEach(t => {
    lp[t] = { ...DEMO_QUOTES[t] };
    liveFlow[t] = { ...DEMO_FLOW[t] };
    liveUnusual[t] = (DEMO_UNUSUAL[t] || []).map(a => ({ ...a }));
    if (DEMO_CHAINS[t]) {
      liveChains[t] = {};
      DEMO_EXPIRATIONS.forEach(exp => {
        liveChains[t][exp] = { c: DEMO_CHAINS[t].c.map(c => ({...c})), p: DEMO_CHAINS[t].p.map(p => ({...p})) };
      });
    }
  });

  updateExpirationDropdowns(DEMO_EXPIRATIONS);
  renderAll();

  // Simulation timers
  demoTimers.push(setInterval(demoTickPrices, 2000));
  demoTimers.push(setInterval(demoTickChainPrices, 3000));
  const pool = [];
  Object.keys(DEMO_UNUSUAL).forEach(t => DEMO_UNUSUAL[t].forEach(a => pool.push({ tk: t, ...a })));
  (function sched() {
    const id = setTimeout(() => { demoInjectOrder(pool); sched(); }, 1500 + Math.random() * 3000);
    demoTimers.push(id);
  })();
}

function demoTickPrices() {
  Object.keys(lp).forEach(t => {
    const p = lp[t]; const spread = Math.max(0.01, (p.last||0) * 0.0003);
    const d = (Math.random() - 0.48) * spread;
    const old = p.last || 0;
    p.last = Math.round((old + d) * 100) / 100;
    p.chg = Math.round(((p.chg||0) + d) * 100) / 100;
    const pe = document.getElementById('tp-' + t);
    const ce = document.getElementById('tc-' + t);
    const se = document.getElementById('sp-' + t);
    if (pe) { pe.textContent = fmtD(p.last); pe.style.color = p.last > old ? 'var(--green)' : p.last < old ? 'var(--red)' : 'var(--white)'; }
    if (ce) { ce.textContent = (p.chg >= 0 ? '+' : '') + fmtD(p.chg); ce.className = 'tk-chg ' + (p.chg >= 0 ? 'up' : 'dn'); }
    if (se) { se.textContent = fmtD(p.last); se.style.color = p.last > old ? 'var(--green)' : p.last < old ? 'var(--red)' : 'var(--white)'; }
  });
}

function demoTickChainPrices() {
  const tk = selectedChainTk;
  const tkChains = liveChains[tk];
  if (!tkChains) return;
  const data = (selectedChainExp && tkChains[selectedChainExp])
    ? tkChains[selectedChainExp]
    : Object.values(tkChains)[0];
  if (!data) return;
  data.c.forEach(c => {
    if (c.b == null || c.a == null) return;
    const sp = c.a - c.b; const mv = (Math.random() - 0.5) * sp * 0.3;
    c.l = Math.max(0.01, Math.round((c.l + mv) * 100) / 100);
    c.b = Math.max(0.01, Math.round((c.b + mv * 0.5) * 100) / 100);
    c.a = Math.max(0.01, Math.round((c.a + mv * 0.5) * 100) / 100);
    if (c.b >= c.a) c.a = c.b + 0.01;
    const el = document.getElementById('cc-' + tk + '-' + c.s); if (el) el.textContent = fmtD(c.l);
  });
  data.p.forEach(p => {
    if (p.b == null || p.a == null) return;
    const sp = p.a - p.b; const mv = (Math.random() - 0.5) * sp * 0.3;
    p.l = Math.max(0.01, Math.round((p.l + mv) * 100) / 100);
    p.b = Math.max(0.01, Math.round((p.b + mv * 0.5) * 100) / 100);
    p.a = Math.max(0.01, Math.round((p.a + mv * 0.5) * 100) / 100);
    if (p.b >= p.a) p.a = p.b + 0.01;
    const el = document.getElementById('cp-' + tk + '-' + p.s); if (el) el.textContent = fmtD(p.l);
  });
}

function demoInjectOrder(pool) {
  const base = pool[Math.floor(Math.random() * pool.length)];
  const v = Math.round(base.v * (0.05 + Math.random() * 0.3));
  const l = Math.round(base.l * (0.97 + Math.random() * 0.06) * 100) / 100;
  const prem = v * l * 100;
  const s = sig(base.d, base.t);
  orderCt++; totalPrem += prem;
  document.getElementById('orderCt').textContent = orderCt.toLocaleString();
  document.getElementById('totalPrem').textContent = fmtP(totalPrem);
  feedAge = 0;

  const tbody = document.getElementById('flowBody');
  const golden = prem > 5e6;
  const rc = base.t === 'C' ? 'call-row' : 'put-row';
  const bc = base.t === 'C' ? 'badge-c' : 'badge-p';
  const tl = base.t === 'C' ? 'CALL' : 'PUT';
  const sc = sigCls(s);
  const gt = golden ? '<span class="golden-tag">\u2605</span>' : '';
  const demoExp = base.exp || DEMO_EXPIRATIONS[Math.floor(Math.random() * DEMO_EXPIRATIONS.length)];
  const oiVal = base.oi ? fmtN(Math.round(base.oi * (0.9 + Math.random() * 0.2))) : '--';
  const tr = document.createElement('tr');
  tr.className = golden ? 'golden-row' : rc;
  tr.innerHTML = `<td><b>${base.tk}</b></td><td><span class="exp-tag">${demoExp}</span></td><td><span class="badge ${bc}">${tl}</span></td><td>$${base.s}</td><td>${fmtD(l)}</td><td>${fmtN(v)}</td><td>${oiVal}</td><td>${gt}<b>${fmtP(prem)}</b></td><td>${base.d.toFixed(4)}</td><td><span class="${sc}">${s}</span></td>`;

  const ft = document.querySelector('.fbtn.on')?.dataset.f || 'all';
  const tk = document.getElementById('tkFilter').value;
  const expF = document.getElementById('expFilter').value;
  let show = true;
  if (ft === 'calls' && base.t !== 'C') show = false;
  if (ft === 'puts' && base.t !== 'P') show = false;
  if (tk && base.tk !== tk) show = false;
  if (expF && !demoExp.includes(expF)) show = false;
  if (!show) tr.style.display = 'none';

  tbody.firstChild ? tbody.insertBefore(tr, tbody.firstChild) : tbody.appendChild(tr);
  while (tbody.children.length > 100) tbody.removeChild(tbody.lastChild);
}

// ==================== CLOCK & FEED AGE ====================
function tickClock() {
  const n = new Date();
  const h = String(n.getHours()).padStart(2, '0');
  const m = String(n.getMinutes()).padStart(2, '0');
  const s = String(n.getSeconds()).padStart(2, '0');
  document.getElementById('clock').textContent = h + ':' + m + ':' + s + ' EST';
  document.getElementById('ftrTime').textContent = n.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + ' ' + h + ':' + m + ':' + s;
}

// ==================== FULL RENDER ====================
function renderAll() {
  renderTickers();
  renderSentiment();
  renderFlow();
  renderChain();
  renderAllCharts();
}

// ==================== INIT ====================
function init() {
  // Setup event listeners
  setupFilters();
  document.getElementById('strikeTk').addEventListener('change', renderStrikeChart);
  document.getElementById('flowDistFilter').addEventListener('change', renderDonuts);
  document.getElementById('chainTk').addEventListener('change', function() {
    selectedChainTk = this.value;
    renderChain();
    renderStrikeChart();
  });
  document.getElementById('chainExp').addEventListener('change', function() {
    selectedChainExp = this.value;
    // When live, request new expiration chain data
    // For now, re-render with available data
    renderChain();
  });

  // Clock
  setInterval(tickClock, 1000);
  setInterval(() => { feedAge++; const e = document.getElementById('feedAge'); if (e) e.textContent = feedAge + 's'; }, 1000);

  // Setup connection overlay (or auto-demo)
  setupConnectionOverlay();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
